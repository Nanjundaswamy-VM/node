"use strict"; // var consul = require('consul')();
var Bluebird = require('bluebird');
var IP_ADDRESS = process.env.IP_ADDRESS || 'localhost';
var CONSUL_ID = require('uuid').v4();
var PORT = Number(process.env.PORT) || 8889;

function fromCallback(fn) {
  return new Bluebird(function (resolve, reject) {
    try {
      return fn(function (err, data, res) {
        if (err) {
          err.res = res;
          return reject(err);
        }
        return resolve([data, res]);
      });
    } catch (err) {
      return reject(err);
    }
  });
}
var consul = require('consul')({ promisify: fromCallback, host: "172.18.40.168" });


consul.acl.bootstrap(function (err, result) {
  console.log(err, result);
  // if (err) throw err;
});


consul.agent.members(function (err, result) {
  console.log('memebrs', err, result);
  if (err) throw err;
});



var known_search_instances = [];

var watcher = consul.watch({
  method: consul.health.service,
  options: {
    service: 'restaurant',
    passing: true } });



watcher.on('change', function (data) {
  known_search_instances = [];
  data.forEach(function (entry) {
    known_search_instances.push("http://".concat(entry.Service.Address, ":").concat(entry.Service.Port, "/"));
  });

  console.log("Available search services ", known_search_instances);
});


var known_order_instances = [];

var orderWatcher = consul.watch({
  method: consul.health.service,
  options: {
    service: 'order',
    passing: true } });



orderWatcher.on('change', function (data) {
  known_order_instances = [];
  data.forEach(function (entry) {
    known_order_instances.push("http://".concat(entry.Service.Address, ":").concat(entry.Service.Port, "/"));
  });

  console.log("Available known_order_instances services ", known_order_instances);
});

var details = {
  name: 'report', // service group name search or order
  address: IP_ADDRESS,
  port: PORT,
  id: CONSUL_ID,
  check: {
    ttl: '10s',
    deregister_critical_service_after: '1m' } };


consul.agent.service.register(details, function (err) {
  // schedule heartbeat
  console.log("register ", err);
});

setInterval(function () {
  consul.agent.check.pass({ id: "service:".concat(CONSUL_ID) }, function (err) {
    if (err) throw new Error(err);
    console.log('told Consul that we are healthy');
  });
}, 5 * 1000);

process.on('SIGINT', function () {
  console.log('SIGINT. De-Registering...');
  var details = { id: CONSUL_ID };

  consul.agent.service.deregister(details, function (err) {
    console.log('de-registered.', err);
    process.exit();
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9jb25zdWwuanMiXSwibmFtZXMiOlsiQmx1ZWJpcmQiLCJyZXF1aXJlIiwiSVBfQUREUkVTUyIsInByb2Nlc3MiLCJlbnYiLCJDT05TVUxfSUQiLCJ2NCIsIlBPUlQiLCJOdW1iZXIiLCJmcm9tQ2FsbGJhY2siLCJmbiIsInJlc29sdmUiLCJyZWplY3QiLCJlcnIiLCJkYXRhIiwicmVzIiwiY29uc3VsIiwicHJvbWlzaWZ5IiwiaG9zdCIsImFjbCIsImJvb3RzdHJhcCIsInJlc3VsdCIsImNvbnNvbGUiLCJsb2ciLCJhZ2VudCIsIm1lbWJlcnMiLCJrbm93bl9zZWFyY2hfaW5zdGFuY2VzIiwid2F0Y2hlciIsIndhdGNoIiwibWV0aG9kIiwiaGVhbHRoIiwic2VydmljZSIsIm9wdGlvbnMiLCJwYXNzaW5nIiwib24iLCJmb3JFYWNoIiwiZW50cnkiLCJwdXNoIiwiU2VydmljZSIsIkFkZHJlc3MiLCJQb3J0Iiwia25vd25fb3JkZXJfaW5zdGFuY2VzIiwib3JkZXJXYXRjaGVyIiwiZGV0YWlscyIsIm5hbWUiLCJhZGRyZXNzIiwicG9ydCIsImlkIiwiY2hlY2siLCJ0dGwiLCJkZXJlZ2lzdGVyX2NyaXRpY2FsX3NlcnZpY2VfYWZ0ZXIiLCJyZWdpc3RlciIsInNldEludGVydmFsIiwicGFzcyIsIkVycm9yIiwiZGVyZWdpc3RlciIsImV4aXQiXSwibWFwcGluZ3MiOiJjQUFBO0FBQ0EsSUFBSUEsUUFBUSxHQUFHQyxPQUFPLENBQUMsVUFBRCxDQUF0QjtBQUNBLElBQU1DLFVBQVUsR0FBR0MsT0FBTyxDQUFDQyxHQUFSLENBQVlGLFVBQVosSUFBMEIsV0FBN0M7QUFDQSxJQUFNRyxTQUFTLEdBQUdKLE9BQU8sQ0FBQyxNQUFELENBQVAsQ0FBZ0JLLEVBQWhCLEVBQWxCO0FBQ0EsSUFBTUMsSUFBSSxHQUFHQyxNQUFNLENBQUNMLE9BQU8sQ0FBQ0MsR0FBUixDQUFZRyxJQUFiLENBQU4sSUFBNEIsSUFBekM7O0FBRUEsU0FBU0UsWUFBVCxDQUFz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RUFXLEVBQUFBLE1BQU0sQ0FBQ1EsS0FBUCxDQUFhTyxPQUFiLENBQXFCd0IsVUFBckIsQ0FBZ0NaLE9BQWhDLEVBQXlDLFVBQUM5QixHQUFELEVBQVM7QUFDaERTLElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLGdCQUFaLEVBQThCVixHQUE5QjtBQUNBVixJQUFBQSxPQUFPLENBQUNxRCxJQUFSO0FBQ0QsR0FIRDtBQUlELENBUkQiLCJzb3VyY2VzQ29udGVudCI6WyIvLyB2YXIgY29uc3VsID0gcmVxdWlyZSgnY29uc3VsJykoKTtcclxudmFyIEJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcclxuY29uc3QgSVBfQUREUkVTUyA9IHByb2Nlc3MuZW52LklQX0FERFJFU1MgfHwgJ2xvY2FsaG9zdCc7XHJcbmNvbnN0IENPTlNVTF9JRCA9IHJlcXVpcmUoJ3V1aWQnKS52NCgpO1xyXG5jb25zdCBQT1JUID0gTnVtYmVyKHByb2Nlc3MuZW52LlBPUlQpIHx8IDg4ODk7XHJcblxyXG5mdW5jdGlvbiBmcm9tQ2FsbGJhY2soZm4pIHtcclxuICAgIHJldHVybiBuZXcgQmx1ZWJpcmQoZnVuY3Rpb24ocmVzb2x2ZSwgcmVqZWN0KSB7XHJcbiAgICAgIHRyeSB7XHJcbiAgICAgICAgcmV0dXJuIGZuKGZ1bmN0aW9uKGVyciwgZGF0YSwgcmVzKSB7XHJcbiAgICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICAgIGVyci5yZXMgPSByZXM7XHJcbiAgICAgICAgICAgIHJldHVybiByZWplY3QoZXJyKTtcclxuICAgICAgICAgIH1cclxuICAgICAgICAgIHJldHVybiByZXNvbHZlKFtkYXRhLCByZXNdKTtcclxuICAgICAgICB9KTtcclxuICAgICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcbnZhciBjb25zdWwgPSByZXF1aXJlKCdjb25zdWwnKSh7IHByb21pc2lmeTogZnJvbUNhbGxiYWNrLGhvc3Q6XCIxNzIuMTguNDAuMTY4XCIgfSk7XHJcblxyXG5cclxuY29uc3VsLmFjbC5ib290c3RyYXAoZnVuY3Rpb24oZXJyLCByZXN1bHQpIHtcclxuICAgIGNvbnNvbGUubG9nKGVyciwgcmVzdWx0KVxyXG4gICAgLy8gaWYgKGVycikgdGhyb3cgZXJyO1xyXG4gIH0pO1xyXG5cclxuXHJcbiAgY29uc3VsLmFnZW50Lm1lbWJlcnMoZnVuY3Rpb24oZXJyLCByZXN1bHQpIHtcclxuICAgIGNvbnNvbGUubG9nKCdtZW1lYnJzJywgZXJyLCByZXN1bHQpXHJcbiAgICBpZiAoZXJyKSB0aHJvdyBlcnI7XHJcbiAgfSk7XHJcblxyXG5cclxuIFxyXG5sZXQga25vd25fc2VhcmNoX2luc3RhbmNlcyA9IFtdO1xyXG5cclxuY29uc3Qgd2F0Y2hlciA9IGNvbnN1bC53YXRjaCh7XHJcbiAgbWV0aG9kOiBjb25zdWwuaGVhbHRoLnNlcnZpY2UsXHJcbiAgb3B0aW9uczoge1xyXG4gICAgc2VydmljZTogJ3Jlc3RhdXJhbnQnLFxyXG4gICAgcGFzc2luZzogdHJ1ZVxyXG4gIH1cclxufSk7XHJcblxyXG53YXRjaGVyLm9uKCdjaGFuZ2UnLCBkYXRhID0+IHtcclxuICAgIGtub3duX3NlYXJjaF9pbnN0YW5jZXMgPSBbXTtcclxuICBkYXRhLmZvckVhY2goZW50cnkgPT4ge1xyXG4gICAga25vd25fc2VhcmNoX2luc3RhbmNlcy5wdXNoKGBodHRwOi8vJHtlbnRyeS5TZXJ2aWNlLkFkZHJlc3N9OiR7ZW50cnkuU2VydmljZS5Qb3J0fS9gKTtcclxuICB9KTtcclxuXHJcbiAgY29uc29sZS5sb2coXCJBdmFpbGFibGUgc2VhcmNoIHNlcnZpY2VzIFwiLCBrbm93bl9zZWFyY2hfaW5zdGFuY2VzKTtcclxufSk7XHJcblxyXG5cclxubGV0IGtub3duX29yZGVyX2luc3RhbmNlcyA9IFtdO1xyXG5cclxuY29uc3Qgb3JkZXJXYXRjaGVyID0gY29uc3VsLndhdGNoKHtcclxuICBtZXRob2Q6IGNvbnN1bC5oZWFsdGguc2VydmljZSxcclxuICBvcHRpb25zOiB7XHJcbiAgICBzZXJ2aWNlOiAnb3JkZXInLFxyXG4gICAgcGFzc2luZzogdHJ1ZVxyXG4gIH1cclxufSk7XHJcblxyXG5vcmRlcldhdGNoZXIub24oJ2NoYW5nZScsIGRhdGEgPT4ge1xyXG4gICAga25vd25fb3JkZXJfaW5zdGFuY2VzID0gW107XHJcbiAgZGF0YS5mb3JFYWNoKGVudHJ5ID0+IHtcclxuICAgIGtub3duX29yZGVyX2luc3RhbmNlcy5wdXNoKGBodHRwOi8vJHtlbnRyeS5TZXJ2aWNlLkFkZHJlc3N9OiR7ZW50cnkuU2VydmljZS5Qb3J0fS9gKTtcclxuICB9KTtcclxuXHJcbiAgY29uc29sZS5sb2coXCJBdmFpbGFibGUga25vd25fb3JkZXJfaW5zdGFuY2VzIHNlcnZpY2VzIFwiLCBrbm93bl9vcmRlcl9pbnN0YW5jZXMpO1xyXG59KTtcclxuXHJcbmxldCBkZXRhaWxzID0ge1xyXG4gIG5hbWU6ICdyZXBvcnQnLCAvLyBzZXJ2aWNlIGdyb3VwIG5hbWUgc2VhcmNoIG9yIG9yZGVyXHJcbiAgYWRkcmVzczogSVBfQUREUkVTUyxcclxuICBwb3J0OiBQT1JULFxyXG4gIGlkOiBDT05TVUxfSUQsXHJcbiAgY2hlY2s6IHtcclxuICAgIHR0bDogJzEwcycsXHJcbiAgICBkZXJlZ2lzdGVyX2NyaXRpY2FsX3NlcnZpY2VfYWZ0ZXI6ICcxbSdcclxuICB9XHJcbn07XHJcbmNvbnN1bC5hZ2VudC5zZXJ2aWNlLnJlZ2lzdGVyKGRldGFpbHMsIGVyciA9PiB7XHJcbiAgLy8gc2NoZWR1bGUgaGVhcnRiZWF0XHJcbiAgY29uc29sZS5sb2coXCJyZWdpc3RlciBcIiwgZXJyKVxyXG59KTsgXHJcblxyXG5zZXRJbnRlcnZhbCgoKSA9PiB7XHJcbiAgICBjb25zdWwuYWdlbnQuY2hlY2sucGFzcyh7aWQ6YHNlcnZpY2U6JHtDT05TVUxfSUR9YH0sIGVyciA9PiB7XHJcbiAgICAgIGlmIChlcnIpIHRocm93IG5ldyBFcnJvcihlcnIpO1xyXG4gICAgICBjb25zb2xlLmxvZygndG9sZCBDb25zdWwgdGhhdCB3ZSBhcmUgaGVhbHRoeScpO1xyXG4gICAgfSk7XHJcbiAgfSwgNSAqIDEwMDApO1xyXG5cclxuICBwcm9jZXNzLm9uKCdTSUdJTlQnLCAoKSA9PiB7XHJcbiAgICBjb25zb2xlLmxvZygnU0lHSU5ULiBEZS1SZWdpc3RlcmluZy4uLicpO1xyXG4gICAgbGV0IGRldGFpbHMgPSB7aWQ6IENPTlNVTF9JRH07XHJcbiAgXHJcbiAgICBjb25zdWwuYWdlbnQuc2VydmljZS5kZXJlZ2lzdGVyKGRldGFpbHMsIChlcnIpID0+IHtcclxuICAgICAgY29uc29sZS5sb2coJ2RlLXJlZ2lzdGVyZWQuJywgZXJyKTtcclxuICAgICAgcHJvY2Vzcy5leGl0KCk7XHJcbiAgICB9KTtcclxuICB9KTtcclxuIl19