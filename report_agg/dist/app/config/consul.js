/**
 * @file
 * config file to handle the consul service.
 */
'use strict';

// var consul = require('consul')();
var Bluebird = require('bluebird');
var IP_ADDRESS = process.env.IP_ADDRESS || 'localhost';
var CONSUL_ID = require('uuid').v4();
var PORT = Number(process.env.PORT) || 8889;
var CN_HOST = "172.18.36.244";

function fromCallback(fn) {
  return new Bluebird(function (resolve, reject) {
    try {
      return fn(function (err, data, res) {
        if (err) {
          err.res = res;
          return reject(err);
        }
        return resolve([data, res]);
      });
    } catch (err) {
      return reject(err);
    }
  });
}
var consul = require('consul')({ promisify: fromCallback, host: CN_HOST });


consul.acl.bootstrap(function (err, result) {
  console.log(err, result);
  // if (err) throw err;
});


consul.agent.members(function (err, result) {
  console.log('memebrs', err, result);
  if (err) throw err;
});



var known_search_instances = [];

var watcher = consul.watch({
  method: consul.health.service,
  options: {
    service: 'restaurant',
    passing: true } });



watcher.on('change', function (data) {
  known_search_instances = [];
  data.forEach(function (entry) {
    known_search_instances.push("http://".concat(entry.Service.Address, ":").concat(entry.Service.Port, "/"));
  });

  console.log("Available search services ", known_search_instances);
});


var known_order_instances = [];

var orderWatcher = consul.watch({
  method: consul.health.service,
  options: {
    service: 'order',
    passing: true } });



orderWatcher.on('change', function (data) {
  known_order_instances = [];
  data.forEach(function (entry) {
    known_order_instances.push("http://".concat(entry.Service.Address, ":").concat(entry.Service.Port, "/"));
  });

  console.log("Available known_order_instances services ", known_order_instances);
});

var details = {
  name: 'report', // service group name search or order
  address: IP_ADDRESS,
  port: PORT,
  id: CONSUL_ID,
  check: {
    ttl: '10s',
    deregister_critical_service_after: '1m' } };


consul.agent.service.register(details, function (err) {
  // schedule heartbeat
  console.log("register ", err);
});

setInterval(function () {
  consul.agent.check.pass({ id: "service:".concat(CONSUL_ID) }, function (err) {
    if (err) throw new Error(err);
    console.log('told Consul that we are healthy');
  });
}, 5 * 1000);

process.on('SIGINT', function () {
  console.log('SIGINT. De-Registering...');
  var details = { id: CONSUL_ID };

  consul.agent.service.deregister(details, function (err) {
    console.log('de-registered.', err);
    process.exit();
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9hcHAvY29uZmlnL2NvbnN1bC5qcyJdLCJuYW1lcyI6WyJCbHVlYmlyZCIsInJlcXVpcmUiLCJJUF9BRERSRVNTIiwicHJvY2VzcyIsImVudiIsIkNPTlNVTF9JRCIsInY0IiwiUE9SVCIsIk51bWJlciIsIkNOX0hPU1QiLCJmcm9tQ2FsbGJhY2siLCJmbiIsInJlc29sdmUiLCJyZWplY3QiLCJlcnIiLCJkYXRhIiwicmVzIiwiY29uc3VsIiwicHJvbWlzaWZ5IiwiaG9zdCIsImFjbCIsImJvb3RzdHJhcCIsInJlc3VsdCIsImNvbnNvbGUiLCJsb2ciLCJhZ2VudCIsIm1lbWJlcnMiLCJrbm93bl9zZWFyY2hfaW5zdGFuY2VzIiwid2F0Y2hlciIsIndhdGNoIiwibWV0aG9kIiwiaGVhbHRoIiwic2VydmljZSIsIm9wdGlvbnMiLCJwYXNzaW5nIiwib24iLCJmb3JFYWNoIiwiZW50cnkiLCJwdXNoIiwiU2VydmljZSIsIkFkZHJlc3MiLCJQb3J0Iiwia25vd25fb3JkZXJfaW5zdGFuY2VzIiwib3JkZXJXYXRjaGVyIiwiZGV0YWlscyIsIm5hbWUiLCJhZGRyZXNzIiwicG9ydCIsImlkIiwiY2hlY2siLCJ0dGwiLCJkZXJlZ2lzdGVyX2NyaXRpY2FsX3NlcnZpY2VfYWZ0ZXIiLCJyZWdpc3RlciIsInNldEludGVydmFsIiwicGFzcyIsIkVycm9yIiwiZGVyZWdpc3RlciIsImV4aXQiXSwibWFwcGluZ3MiOiJBQUFBOzs7O0FBSUE7O0FBRUE7QUFDQSxJQUFJQSxRQUFRLEdBQUdDLE9BQU8sQ0FBQyxVQUFELENBQXRCO0FBQ0EsSUFBTUMsVUFBVSxHQUFHQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUYsVUFBWixJQUEwQixXQUE3QztBQUNBLElBQU1HLFNBQVMsR0FBR0osT0FBTyxDQUFDLE1BQUQsQ0FBUCxDQUFnQkssRUFBaEIsRUFBbEI7QUFDQSxJQUFNQyxJQUFJLEdBQUdDLE1BQU0sQ0FBQ0wsT0FBTyxDQUFDQyxHQUFSLENBQVlHLElB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QyxHQUFSLENBQVksMkJBQVo7QUFDQSxNQUFJb0IsT0FBTyxHQUFHLEVBQUVJLEVBQUUsRUFBRTNDLFNBQU4sRUFBZDs7QUFFQVksRUFBQUEsTUFBTSxDQUFDUSxLQUFQLENBQWFPLE9BQWIsQ0FBcUJ3QixVQUFyQixDQUFnQ1osT0FBaEMsRUFBeUMsVUFBQzlCLEdBQUQsRUFBUztBQUNoRFMsSUFBQUEsT0FBTyxDQUFDQyxHQUFSLENBQVksZ0JBQVosRUFBOEJWLEdBQTlCO0FBQ0FYLElBQUFBLE9BQU8sQ0FBQ3NELElBQVI7QUFDRCxHQUhEO0FBSUQsQ0FSRCIsInNvdXJjZXNDb250ZW50IjpbIi8qKlxyXG4gKiBAZmlsZVxyXG4gKiBjb25maWcgZmlsZSB0byBoYW5kbGUgdGhlIGNvbnN1bCBzZXJ2aWNlLlxyXG4gKi9cclxuJ3VzZSBzdHJpY3QnO1xyXG5cclxuLy8gdmFyIGNvbnN1bCA9IHJlcXVpcmUoJ2NvbnN1bCcpKCk7XHJcbnZhciBCbHVlYmlyZCA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XHJcbmNvbnN0IElQX0FERFJFU1MgPSBwcm9jZXNzLmVudi5JUF9BRERSRVNTIHx8ICdsb2NhbGhvc3QnO1xyXG5jb25zdCBDT05TVUxfSUQgPSByZXF1aXJlKCd1dWlkJykudjQoKTtcclxuY29uc3QgUE9SVCA9IE51bWJlcihwcm9jZXNzLmVudi5QT1JUKSB8fCA4ODg5O1xyXG5jb25zdCBDTl9IT1NUID0gXCIxNzIuMTguMzYuMjQ0XCI7XHJcblxyXG5mdW5jdGlvbiBmcm9tQ2FsbGJhY2soZm4pIHtcclxuICByZXR1cm4gbmV3IEJsdWViaXJkKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHtcclxuICAgIHRyeSB7XHJcbiAgICAgIHJldHVybiBmbihmdW5jdGlvbiAoZXJyLCBkYXRhLCByZXMpIHtcclxuICAgICAgICBpZiAoZXJyKSB7XHJcbiAgICAgICAgICBlcnIucmVzID0gcmVzO1xyXG4gICAgICAgICAgcmV0dXJuIHJlamVjdChlcnIpO1xyXG4gICAgICAgIH1cclxuICAgICAgICByZXR1cm4gcmVzb2x2ZShbZGF0YSwgcmVzXSk7XHJcbiAgICAgIH0pO1xyXG4gICAgfSBjYXRjaCAoZXJyKSB7XHJcbiAgICAgIHJldHVybiByZWplY3QoZXJyKTtcclxuICAgIH1cclxuICB9KTtcclxufVxyXG52YXIgY29uc3VsID0gcmVxdWlyZSgnY29uc3VsJykoeyBwcm9taXNpZnk6IGZyb21DYWxsYmFjaywgaG9zdDogQ05fSE9TVCB9KTtcclxuXHJcblxyXG5jb25zdWwuYWNsLmJvb3RzdHJhcChmdW5jdGlvbiAoZXJyLCByZXN1bHQpIHtcclxuICBjb25zb2xlLmxvZyhlcnIsIHJlc3VsdClcclxuICAvLyBpZiAoZXJyKSB0aHJvdyBlcnI7XHJcbn0pO1xyXG5cclxuXHJcbmNvbnN1bC5hZ2VudC5tZW1iZXJzKGZ1bmN0aW9uIChlcnIsIHJlc3VsdCkge1xyXG4gIGNvbnNvbGUubG9nKCdtZW1lYnJzJywgZXJyLCByZXN1bHQpXHJcbiAgaWYgKGVycikgdGhyb3cgZXJyO1xyXG59KTtcclxuXHJcblxyXG5cclxubGV0IGtub3duX3NlYXJjaF9pbnN0YW5jZXMgPSBbXTtcclxuXHJcbmNvbnN0IHdhdGNoZXIgPSBjb25zdWwud2F0Y2goe1xyXG4gIG1ldGhvZDogY29uc3VsLmhlYWx0aC5zZXJ2aWNlLFxyXG4gIG9wdGlvbnM6IHtcclxuICAgIHNlcnZpY2U6ICdyZXN0YXVyYW50JyxcclxuICAgIHBhc3Npbmc6IHRydWVcclxuICB9XHJcbn0pO1xyXG5cclxud2F0Y2hlci5vbignY2hhbmdlJywgZGF0YSA9PiB7XHJcbiAga25vd25fc2VhcmNoX2luc3RhbmNlcyA9IFtdO1xyXG4gIGRhdGEuZm9yRWFjaChlbnRyeSA9PiB7XHJcbiAgICBrbm93bl9zZWFyY2hfaW5zdGFuY2VzLnB1c2goYGh0dHA6Ly8ke2VudHJ5LlNlcnZpY2UuQWRkcmVzc306JHtlbnRyeS5TZXJ2aWNlLlBvcnR9L2ApO1xyXG4gIH0pO1xyXG5cclxuICBjb25zb2xlLmxvZyhcIkF2YWlsYWJsZSBzZWFyY2ggc2VydmljZXMgXCIsIGtub3duX3NlYXJjaF9pbnN0YW5jZXMpO1xyXG59KTtcclxuXHJcblxyXG5sZXQga25vd25fb3JkZXJfaW5zdGFuY2VzID0gW107XHJcblxyXG5jb25zdCBvcmRlcldhdGNoZXIgPSBjb25zdWwud2F0Y2goe1xyXG4gIG1ldGhvZDogY29uc3VsLmhlYWx0aC5zZXJ2aWNlLFxyXG4gIG9wdGlvbnM6IHtcclxuICAgIHNlcnZpY2U6ICdvcmRlcicsXHJcbiAgICBwYXNzaW5nOiB0cnVlXHJcbiAgfVxyXG59KTtcclxuXHJcbm9yZGVyV2F0Y2hlci5vbignY2hhbmdlJywgZGF0YSA9PiB7XHJcbiAga25vd25fb3JkZXJfaW5zdGFuY2VzID0gW107XHJcbiAgZGF0YS5mb3JFYWNoKGVudHJ5ID0+IHtcclxuICAgIGtub3duX29yZGVyX2luc3RhbmNlcy5wdXNoKGBodHRwOi8vJHtlbnRyeS5TZXJ2aWNlLkFkZHJlc3N9OiR7ZW50cnkuU2VydmljZS5Qb3J0fS9gKTtcclxuICB9KTtcclxuXHJcbiAgY29uc29sZS5sb2coXCJBdmFpbGFibGUga25vd25fb3JkZXJfaW5zdGFuY2VzIHNlcnZpY2VzIFwiLCBrbm93bl9vcmRlcl9pbnN0YW5jZXMpO1xyXG59KTtcclxuXHJcbmxldCBkZXRhaWxzID0ge1xyXG4gIG5hbWU6ICdyZXBvcnQnLCAvLyBzZXJ2aWNlIGdyb3VwIG5hbWUgc2VhcmNoIG9yIG9yZGVyXHJcbiAgYWRkcmVzczogSVBfQUREUkVTUyxcclxuICBwb3J0OiBQT1JULFxyXG4gIGlkOiBDT05TVUxfSUQsXHJcbiAgY2hlY2s6IHtcclxuICAgIHR0bDogJzEwcycsXHJcbiAgICBkZXJlZ2lzdGVyX2NyaXRpY2FsX3NlcnZpY2VfYWZ0ZXI6ICcxbSdcclxuICB9XHJcbn07XHJcbmNvbnN1bC5hZ2VudC5zZXJ2aWNlLnJlZ2lzdGVyKGRldGFpbHMsIGVyciA9PiB7XHJcbiAgLy8gc2NoZWR1bGUgaGVhcnRiZWF0XHJcbiAgY29uc29sZS5sb2coXCJyZWdpc3RlciBcIiwgZXJyKVxyXG59KTtcclxuXHJcbnNldEludGVydmFsKCgpID0+IHtcclxuICBjb25zdWwuYWdlbnQuY2hlY2sucGFzcyh7IGlkOiBgc2VydmljZToke0NPTlNVTF9JRH1gIH0sIGVyciA9PiB7XHJcbiAgICBpZiAoZXJyKSB0aHJvdyBuZXcgRXJyb3IoZXJyKTtcclxuICAgIGNvbnNvbGUubG9nKCd0b2xkIENvbnN1bCB0aGF0IHdlIGFyZSBoZWFsdGh5Jyk7XHJcbiAgfSk7XHJcbn0sIDUgKiAxMDAwKTtcclxuXHJcbnByb2Nlc3Mub24oJ1NJR0lOVCcsICgpID0+IHtcclxuICBjb25zb2xlLmxvZygnU0lHSU5ULiBEZS1SZWdpc3RlcmluZy4uLicpO1xyXG4gIGxldCBkZXRhaWxzID0geyBpZDogQ09OU1VMX0lEIH07XHJcblxyXG4gIGNvbnN1bC5hZ2VudC5zZXJ2aWNlLmRlcmVnaXN0ZXIoZGV0YWlscywgKGVycikgPT4ge1xyXG4gICAgY29uc29sZS5sb2coJ2RlLXJlZ2lzdGVyZWQuJywgZXJyKTtcclxuICAgIHByb2Nlc3MuZXhpdCgpO1xyXG4gIH0pO1xyXG59KTtcclxuIl19